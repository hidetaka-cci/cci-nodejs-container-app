version: 2.1

# CircleCI Orbsの定義
orbs:
  node: circleci/node@7.2.1
  aws-cli: circleci/aws-cli@5.4.1
  aws-ecr: circleci/aws-ecr@9.8.1
  aws-ecs: circleci/aws-ecs@6.0.2

# ジョブ定義
jobs:
  # TypeScriptビルド
  build:
    executor: node/default
    steps:
      - checkout
      # node orbでパッケージマネージャーの検知とキャッシュ管理を自動化
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: TypeScriptビルド
          command: npm run build
      # Dockerfile内でビルドしてdistを生成するため、workspace永続化は不要

  # vitestによる自動テスト実行
  test:
    executor: node/default
    steps:
      - checkout
      # node orbでパッケージマネージャーの検知とキャッシュ管理を自動化
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run tests with JUnit reporter
          command: |
            mkdir -p test-results
            npm test -- --reporter=junit --outputFile=test-results/junit.xml --coverage
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage



# ワークフロー定義
workflows:
  build-test-deploy:
    jobs:
      # buildとtestを並列実行
      - build
      - test
      # ECRへのpushはbuildとtestの両方が成功した後に実行
      # OIDC認証を使用（context必須）
      - aws-ecr/build_and_push_image:
          context: aws-oidc
          auth:
            - aws-cli/setup:
                role_arn: ${AWS_ROLE_ARN}
                region: ${AWS_REGION}
          repo: ${ECR_REPO_NAME}
          tag: ${CIRCLE_SHA1}
          requires:
            - build
            - test
          filters:
            branches:
              only: main  # mainブランチのみECRにプッシュ
      # ECSへのデプロイはECRへのpush成功後に実行
      # OIDC認証を使用（context必須）
      # aws-ecs Orbを使用してサービス更新
      - aws-ecs/deploy_service_update:
          context: aws-oidc
          auth:
            - aws-cli/setup:
                role_arn: ${AWS_ROLE_ARN}
                region: ${AWS_REGION}
          cluster: ${ECS_CLUSTER_NAME}
          service_name: ${ECS_SERVICE_NAME}
          family: cci-nodejs-container-app
          container_image_name_updates: "container=cci-nodejs-container-app,tag=${CIRCLE_SHA1}"
          requires:
            - aws-ecr/build_and_push_image
          filters:
            branches:
              only: main  # mainブランチのみデプロイ
